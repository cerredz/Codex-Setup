comprehensive security and dependency analysis report. When provided with FastAPI route definitions and their associated dependency chains, decorators, and middleware, your mandatory first step is to conduct an exhaustive audit that systematically examines every security dimension, implementation pattern, and potential vulnerability before proposing any enhancements. You must document the complete dependency injection stack for each route, explicitly mapping the execution order of dependencies (path operation decorators, Depends() chains, middleware layers, background tasks) and identifying what each component handles (authentication via OAuth2/JWT schemes, authorization through permission checks, rate limiting, request validation via Pydantic models, response models, error handlers, CORS policies). For every route analyzed, specify the exact file path, HTTP method, endpoint pattern, current dependencies in execution sequence, and any applied middleware—then evaluate each component against security best practices: verify authentication dependencies are present and correctly ordered (Security() with OAuth2PasswordBearer, API key validation), confirm authorization logic properly restricts access based on roles/scopes/ownership, validate that Pydantic models enforce strict input validation with proper field constraints to prevent injection attacks, assess rate limiting implementations for DoS protection, and examine exception handlers to ensure no sensitive information leakage. Cross-reference any security patterns/useful experts inside of in .claude/commands/SKILL_INDEX.md to identify missing protections, and explicitly call out routes that lack critical dependencies (unauthenticated endpoints that should require Depends(get_current_user), public routes missing rate limiters, mutations without CSRF validation, file uploads without content-type/size restrictions, database operations without parameterized queries). Your audit report must include vulnerability assessment for each route: identify specific attack vectors the current dependency chain does not defend against (authentication bypass, authorization gaps, mass assignment vulnerabilities, path traversal, timing attacks, NoSQL injection, IDOR vulnerabilities), document severity levels (critical/high/medium/low) with OWASP API Security Top 10 or CWE references, and provide concrete exploit scenarios. For enhancement recommendations, specify exact dependency additions or modifications: detail the precise position in the dependency chain where new Depends() calls should be inserted, reference FastAPI security utilities (HTTPBearer, APIKeyHeader, OAuth2AuthorizationCodeBearer), recommend Pydantic model improvements (Field() constraints, custom validators, extra='forbid' settings), suggest middleware implementations (trusted host, gzip compression, request ID tracking), and include implementation code examples with proper type hints and dependency injection patterns. Analyze performance implications—identify redundant dependency calls that could be cached using lru_cache, flag synchronous database calls that should use async SQLAlchemy, note missing response_model specifications, and assess whether background tasks should replace blocking operations. Document consistency issues across routes where similar endpoints have different security dependencies or validation patterns, and recommend standardization strategies through reusable dependency factories and base models. Include compliance considerations if relevant (GDPR, PCI-DSS, HIPAA), ensure all recommendations align with defense-in-depth principles through multiple overlapping security layers, and verify that proposed Pydantic models use appropriate settings for immutability and runtime safety. Do not implement any dependency modifications, alter route configurations, add middleware, or write remediation code until this middleware-audit.md report has been reviewed and explicitly approved—all security enhancements must be validated as necessary and correctly prioritized before any code changes begin.
